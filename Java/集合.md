# Collection

## Set

### TreeSet

åŸºäºçº¢é»‘æ ‘å®ç°(TreeMap)ï¼Œæ”¯æŒæœ‰åºæ€§æ“ä½œï¼ˆå®ç°äº†NavigableSetæ¥å£ï¼‰ï¼Œä¾‹å¦‚æ ¹æ®ä¸€ä¸ªèŒƒå›´æŸ¥æ‰¾å…ƒç´ çš„æ“ä½œï¼Œä½†æ˜¯æŸ¥æ‰¾æ•ˆç‡ä¸å¦‚HashSetï¼ŒHashSetæŸ¥æ‰¾çš„æ•ˆç‡æ˜¯O(1)ï¼ŒTreeSetæŸ¥æ‰¾çš„æ•ˆç‡æ˜¯O(logn)

```java
TreeSet<Integer> set = new TreeSet<>(List.of(1, 3, 5, 7, 9));
Set<Integer> subset = set.subSet(3, true, 7, false); // [3,5] æ ¹æ®å¸ƒå°”å€¼æ§åˆ¶æ˜¯å¦åŒ…å«è¾¹ç•Œ
Set<Integer> head = set.headSet(5, true); // [1,3,5]
```

### HashSet

åŸºäºå“ˆå¸Œè¡¨å®ç°ï¼Œæ”¯æŒå¿«é€ŸæŸ¥æ‰¾ï¼Œä½†ä¸æ”¯æŒæœ‰åºæ€§æ“ä½œ

#### HashSetå¦‚ä½•æ£€æŸ¥é‡å¤

è°ƒç”¨HashMapçš„putæ–¹æ³•ï¼Œå¦‚æœè¿”å›çš„æ˜¯nullï¼Œè¯´æ˜æ’å…¥æˆåŠŸï¼Œæ²¡æœ‰é‡å¤ï¼Œå¦‚æœè¿”å›æœ‰å€¼ï¼ˆè¯¥keyçš„å‰ä¸€ä¸ªvalï¼‰

```java
// Returns: true if this set did not already contain the specified element
// è¿”å›å€¼ï¼šå½“ set ä¸­æ²¡æœ‰åŒ…å« add çš„å…ƒç´ æ—¶è¿”å›çœŸ
public boolean add(E e) {
        return map.put(e, PRESENT)==null;
}
```



### LinkedHashSet

åŸºäº `LinkedHashMap` å®ç°ï¼Œå†…éƒ¨ä½¿ç”¨åŒå‘é“¾è¡¨ç»´æŠ¤å…ƒç´ çš„æ’å…¥é¡ºåºï¼Œç›¸æ¯”HashMap.Nodeå¤šäº†ä¸¤ä¸ªå­—æ®µï¼Œbeforeï¼šå‰ä¸€ä¸ªæ’å…¥çš„Entryï¼Œafterï¼šåä¸€ä¸ªæ’å…¥çš„Entryï¼Œæ³¨æ„ï¼šnodeçš„æ˜¯nextæŒ‡é’ˆ

```java
static class Entry<K,V> extends HashMap.Node<K,V> {
    Entry<K,V> before, after;
}

+--------+        +--------+        +--------+
|  "A"   | <----> |  "B"   | <----> |  "C"   |
+--------+        +--------+        +--------+
 â†‘ Hashæ¡¶                       â†‘ æ’å…¥é¡ºåºé“¾è¡¨
```

## List

### ArrayList

åº•å±‚æ˜¯é€šè¿‡æ•°ç»„å®ç°ï¼Œå…è®¸æ”¾å…¥nullå…ƒç´ ï¼Œéçº¿ç¨‹å®‰å…¨ï¼›

ArrayListæœ‰ä¸€ä¸ªå®¹é‡capacityï¼Œè¡¨ç¤ºåº•å±‚æ•°ç»„çš„å®é™…å¤§å°ï¼Œå¦‚æœå®¹é‡ä¸è¶³ï¼Œä¼šè‡ªåŠ¨å¢å¤§åº•å±‚æ•°ç»„çš„å¤§å°

![image-20250727162136838](../img/collections/image-20250727162136838.png)

#### ArrayListè‡ªåŠ¨æ‰©å®¹

å‘æ•°ç»„æ·»åŠ å…ƒç´ æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥æ·»åŠ åå…ƒç´ çš„ä¸ªæ•°æ˜¯å¦ä¼šè¶…å‡ºå½“å‰æ•°ç»„çš„é•¿åº¦ï¼Œå¦‚æœè¶…å‡ºï¼Œå°±ä¼šå¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹ï¼ˆå†…éƒ¨ä½¿ç”¨ensureCapacityInternalï¼Œå¤–éƒ¨åœ¨å®é™…æ·»åŠ å¤§é‡å…ƒç´ å‰ï¼Œå¯ä½¿ç”¨ensureCapacityæ–¹æ³•å¢åŠ ArrayListå®¹é‡ï¼‰ï¼Œæ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæ•°ç»„å®¹é‡æ‰©ä¸º10

æ•°ç»„æ‰©å®¹æ—¶ï¼Œä¼šå°†è€æ•°ç»„çš„å…ƒç´ æ‹·è´åˆ°æ–°çš„æ•°ç»„ï¼ˆ`elementData = Arrays.copyOf(elementData, newCapacity`)ï¼Œæ¯æ¬¡å¢é•¿æ˜¯åŸæ¥çš„1.5å€ï¼ˆ`newCapacity = oldCapacity + (oldCapacity >> 1)`ï¼‰

åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥å°½é‡é¿å…æ•°ç»„å®¹é‡çš„æ‰©å¼ ã€‚å½“æˆ‘ä»¬å¯é¢„çŸ¥è¦ä¿å­˜çš„å…ƒç´ çš„å¤šå°‘æ—¶ï¼Œè¦åœ¨æ„é€ ArrayListå®ä¾‹æ—¶ï¼Œå°±æŒ‡å®šå…¶å®¹é‡ï¼Œä»¥é¿å…æ•°ç»„æ‰©å®¹çš„å‘ç”Ÿã€‚æˆ–è€…æ ¹æ®å®é™…éœ€æ±‚ï¼Œé€šè¿‡è°ƒç”¨ensureCapacityæ–¹æ³•æ¥æ‰‹åŠ¨å¢åŠ ArrayListå®ä¾‹çš„å®¹é‡

<img src="../img/collections/image-20250727205858065.png" alt="image-20250727205858065" style="zoom:67%;" />

#### ArrayListä¸ºä»€ä¹ˆæŸ¥è¯¢å¿«ï¼Œå¢åˆ æ…¢

`ArrayList` åº•å±‚æ˜¯è¿ç»­å†…å­˜çš„æ•°ç»„ï¼Œå¯ä»¥é€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½åˆ°å…ƒç´ 

```java
E element = elementData[index];  // ç›´æ¥é€šè¿‡ä¸‹æ ‡è®¿é—®
```

å¢åˆ æ…¢æ˜¯å› ä¸ºæ’å…¥æˆ–åˆ é™¤æ—¶ï¼Œéœ€è¦å°†æ–°å…ƒç´ åé¢çš„å…ƒç´ éƒ½å‘åæˆ–å‘å‰ç§»ä¸€ä½

#### ArrayListçš„Fail-Fastæœºåˆ¶

ArrayListé‡‡ç”¨å¿«é€Ÿå¤±è´¥æœºåˆ¶ï¼Œåœ¨**éå†é›†åˆæ—¶ï¼Œå¦‚æœé›†åˆç»“æ„å‘ç”Ÿäº†â€œå¹¶å‘ä¿®æ”¹â€ï¼Œç«‹åˆ»æŠ›å‡º `ConcurrentModificationException` å¼‚å¸¸**ï¼Œè€Œä¸æ˜¯ç»§ç»­æ‰§è¡Œå¯èƒ½å¯¼è‡´é”™è¯¯çš„æ“ä½œ

`ArrayList` æœ‰ä¸€ä¸ªå­—æ®µ

```java
protected transient int modCount = 0;
```

æ¯å½“ç»“æ„æ€§ä¿®æ”¹ï¼ˆå¦‚ `add()`ã€`remove()`ã€`clear()`ï¼‰å‘ç”Ÿæ—¶ï¼Œ`modCount` å°±ä¼šè‡ªå¢

éç»“æ„æ€§ä¿®æ”¹ï¼ˆå¦‚ `set(index, value)`ï¼‰ä¸ä¼šæ›´æ”¹ `modCount`

`ArrayList` çš„è¿­ä»£å™¨åœ¨åˆ›å»ºæ—¶ä¼šä¿å­˜ `modCount` çš„å€¼

```java
int expectedModCount = modCount;
```

åœ¨è°ƒç”¨ `next()`ã€`remove()` ç­‰æ–¹æ³•æ—¶ï¼Œä¼šè¿›è¡Œæ£€æŸ¥

```java
if (modCount != expectedModCount)
    throw new ConcurrentModificationException();
```

**å“ªäº›éå†ä¼šæŠ›å¼‚å¸¸**

```java
List<String> list = new ArrayList<>(List.of("a", "b", "c"));

for (String s : list) {
    if (s.equals("b")) {
        list.remove(s); // ğŸš¨ æŠ›å¼‚å¸¸
    }
}

Iterator<String> it = list.iterator();

while (it.hasNext()) {
    String s = it.next();
    list.remove(s); // ğŸš¨ æŠ›å¼‚å¸¸
}

for (int i = 0; i < list.size(); i++) {
    list.remove(i); // ğŸš¨ ä¼šè·³å…ƒç´ ï¼Œä¹Ÿå¯èƒ½æŠ›å¼‚å¸¸ï¼ˆä¸æ˜¯ä¸€å®šï¼‰
}
```

**å“ªäº›éå†ä¸ä¼šæŠ›å¼‚å¸¸**

```java
Iterator<String> it = list.iterator();
while (it.hasNext()) {
    String s = it.next();
    if (s.equals("b")) {
        it.remove(); // âœ… æ­£ç¡®åšæ³•
    }
}

CopyOnWriteArrayList<String> list = new CopyOnWriteArrayList<>(List.of("a", "b", "c"));
for (String s : list) {
    if (s.equals("b")) {
        list.remove(s); // âœ… ä¸æŠ›å¼‚å¸¸ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œä½†å¼€é”€è¾ƒå¤§
    }
}
```



### CopyOnWriteArrayList

CopyOnWriteArrayListé‡‡ç”¨å†™æ—¶å¤åˆ¶çš„æ€æƒ³ï¼š

å³è¯»å–å…ƒç´ æ—¶ä¸åŠ é”ï¼Œä»åº•å±‚æ•°ç»„ä¸­è¯»å–ï¼›å¯¹å…¶è¿›è¡Œä¿®æ”¹æ“ä½œæ—¶åŠ é”ï¼Œä¼šå¤åˆ¶åº•å±‚æ•°ç»„O(n)ï¼Œåˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„å‰¯æœ¬ï¼Œå†åœ¨æ–°æ•°ç»„ä¸­è¿›è¡Œä¿®æ”¹ï¼Œå†™å…¥å®Œæˆåï¼Œå†å°†æ–°çš„æ•°ç»„è®¾ç½®ä¸ºå½“å‰çš„åº•å±‚æ•°ç»„

å†™æ—¶å¤åˆ¶é€‚åˆè¯»å¤šå†™å°‘çš„å¹¶å‘åœºæ™¯ï¼Œèƒ½æå¤§æé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½

**ç¼ºç‚¹**

- å†…å­˜å ç”¨ï¼šæ¯æ¬¡ä¿®æ”¹æ“ä½œï¼Œéƒ½è¦å¤åˆ¶ä¸€ä»½åŸå§‹æ•°æ®ï¼Œå ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´ï¼Œæ•°æ®é‡å¤§æ—¶å¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³
- å†™æ“ä½œå¼€é”€ï¼Œæ¯æ¬¡å†™æ“ä½œéƒ½éœ€è¦å¤åˆ¶ä¸€ä»½åŸå§‹æ•°æ®ï¼Œå†è¿›è¡Œä¿®æ”¹å’Œæ›¿æ¢ï¼Œå¢å¤§äº†å†™æ“ä½œå¼€é”€
- æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼šåœ¨å†™å®Œä¹‹åä¸æ˜¯ç«‹å³ç”Ÿæ•ˆï¼Œå…ˆå¤åˆ¶ï¼Œå†å†™ï¼Œå†æ›¿æ¢ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¯»åˆ°çš„æ•°æ®å°±æ˜¯æ—§æ•°æ®

**addæºç **

```java
// æ’å…¥å…ƒç´ åˆ° CopyOnWriteArrayList çš„å°¾éƒ¨
public boolean add(E e) {
    final ReentrantLock lock = this.lock;
    // åŠ é”
    lock.lock();
    try {
        // è·å–åŸæ¥çš„æ•°ç»„
        Object[] elements = getArray();
        // åŸæ¥æ•°ç»„çš„é•¿åº¦
        int len = elements.length;
        // åˆ›å»ºä¸€ä¸ªé•¿åº¦+1çš„æ–°æ•°ç»„ï¼Œå¹¶å°†åŸæ¥æ•°ç»„çš„å…ƒç´ å¤åˆ¶ç»™æ–°æ•°ç»„
        Object[] newElements = Arrays.copyOf(elements, len + 1);
        // å…ƒç´ æ”¾åœ¨æ–°æ•°ç»„æœ«å°¾
        newElements[len] = e;
        // arrayæŒ‡å‘æ–°æ•°ç»„
        setArray(newElements);
        return true;
    } finally {
        // è§£é”
        lock.unlock();
    }
}
```

**è¯»å–å…ƒç´ æºç **ï¼ˆå¼±ä¸€è‡´æ€§ï¼‰

```java
// åº•å±‚æ•°ç»„ï¼Œåªèƒ½é€šè¿‡getArrayå’ŒsetArrayæ–¹æ³•è®¿é—®
private transient volatile Object[] array; // volatileä¿è¯å¯è§æ€§ï¼Œå†™çº¿ç¨‹å¯¹ array çš„ä¿®æ”¹ï¼Œå¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§

public E get(int index) {
    return get(getArray(), index);
}

final Object[] getArray() {
    return array;
}

private E get(Object[] a, int index) {
    return (E) a[index];
}
```

**è·å–åˆ—è¡¨ä¸­å…ƒç´ ä¸ªæ•°**

```java
public int size() {
    return getArray().length;
}
```

`CopyOnWriteArrayList`ä¸­çš„`array`æ•°ç»„æ¯æ¬¡å¤åˆ¶éƒ½åˆšå¥½èƒ½å¤Ÿå®¹çº³ä¸‹æ‰€æœ‰å…ƒç´ ï¼Œå¹¶ä¸åƒ`ArrayList`é‚£æ ·ä¼šé¢„ç•™ä¸€å®šçš„ç©ºé—´ã€‚å› æ­¤ï¼Œ`CopyOnWriteArrayList`ä¸­å¹¶æ²¡æœ‰`size`å±æ€§`CopyOnWriteArrayList`çš„åº•å±‚æ•°ç»„çš„é•¿åº¦å°±æ˜¯å…ƒç´ ä¸ªæ•°ï¼Œå› æ­¤`size()`æ–¹æ³•åªè¦è¿”å›æ•°ç»„é•¿åº¦å°±å¯ä»¥äº†

**åˆ é™¤å…ƒç´ **

```java
public E remove(int index) {
    // è·å–å¯é‡å…¥é”
    final ReentrantLock lock = this.lock;
    // åŠ é”
    lock.lock();
    try {
         //è·å–å½“å‰arrayæ•°ç»„
        Object[] elements = getArray();
        // è·å–å½“å‰arrayé•¿åº¦
        int len = elements.length;
        //è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ (æ—§å€¼)
        E oldValue = get(elements, index);
        int numMoved = len - index - 1;
        // åˆ¤æ–­åˆ é™¤çš„æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªå…ƒç´ 
        if (numMoved == 0)
             // å¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥å¤åˆ¶è¯¥å…ƒç´ å‰çš„æ‰€æœ‰å…ƒç´ åˆ°æ–°çš„æ•°ç»„
            setArray(Arrays.copyOf(elements, len - 1));
        else {
            // åˆ†æ®µå¤åˆ¶ï¼Œå°†indexå‰çš„å…ƒç´ å’Œindex+1åçš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„
            // æ–°æ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦-1
            Object[] newElements = new Object[len - 1];
            System.arraycopy(elements, 0, newElements, 0, index);
            System.arraycopy(elements, index + 1, newElements, index,
                             numMoved);
            //å°†æ–°æ•°ç»„èµ‹å€¼ç»™arrayå¼•ç”¨
            setArray(newElements);
        }
        return oldValue;
    } finally {
         // è§£é”
        lock.unlock();
    }
}
```

#### CopyOnWriteArrayListä¸ºä»€ä¹ˆå¹¶å‘å®‰å…¨ä¸”æ€§èƒ½æ¯”Vectorå¥½

CopyOnWriteArrayListä¿®æ”¹æ—¶åŠ é”ï¼ˆreentrantlockï¼‰ï¼ŒVectorè¯»å–å’Œä¿®æ”¹æ—¶éƒ½åŠ é”ï¼ˆsynchronizedï¼‰

## Queue

### ConcurrentLinkedQueue

åº•å±‚ç»“æ„â€”â€”é“¾è¡¨

![image-20250728212904132](../img/collections/image-20250728212904132.png)

**offerå‡½æ•°æºç **

```java
public boolean offer(E e) {
    // å…ƒç´ ä¸ä¸ºnull
    checkNotNull(e);
    // æ–°ç”Ÿä¸€ä¸ªç»“ç‚¹
    final Node<E> newNode = new Node<E>(e);

    for (Node<E> t = tail, p = t;;) { // æ— é™å¾ªç¯
        // qä¸ºpç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹
        Node<E> q = p.next;
        if (q == null) { // qç»“ç‚¹ä¸ºnull
            // p is last node
            if (p.casNext(null, newNode)) { // æ¯”è¾ƒå¹¶è¿›è¡Œæ›¿æ¢pç»“ç‚¹çš„nextåŸŸ
                // Successful CAS is the linearization point
                // for e to become an element of this queue,
                // and for newNode to become "live".
                if (p != t) // pä¸ç­‰äºtç»“ç‚¹ï¼Œä¸ä¸€è‡´    // hop two nodes at a time
                    // æ¯”è¾ƒå¹¶æ›¿æ¢å°¾ç»“ç‚¹
                    casTail(t, newNode);  // Failure is OK.
                // è¿”å›
                return true;
            }
            // Lost CAS race to another thread; re-read next
        }
        else if (p == q) // pç»“ç‚¹ç­‰äºqç»“ç‚¹
            // We have fallen off list.  If tail is unchanged, it
            // will also be off-list, in which case we need to
            // jump to head, from which all live nodes are always
            // reachable.  Else the new tail is a better bet.
            // åŸæ¥çš„å°¾ç»“ç‚¹ä¸ç°åœ¨çš„å°¾ç»“ç‚¹æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™pèµ‹å€¼ä¸ºheadï¼Œå¦åˆ™ï¼Œèµ‹å€¼ä¸ºç°åœ¨çš„å°¾ç»“ç‚¹
            p = (t != (t = tail)) ? t : head;
        else
            // Check for tail updates after two hops.
            // é‡æ–°èµ‹å€¼pç»“ç‚¹
            p = (p != t && t != (t = tail)) ? t : q;
    }
}
```

offerå°†æŒ‡å®šå…ƒç´ æ’å…¥åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼ˆå‡è®¾å•çº¿ç¨‹æ·»åŠ å…ƒç´ ï¼Œè¿ç»­æ·»åŠ 10ã€20ä¸¤ä¸ªå…ƒç´ ï¼‰

åˆå§‹çŠ¶æ€

![image-20250728213141126](../img/collections/image-20250728213141126.png)

æ·»åŠ 10

![image-20250728213155068](../img/collections/image-20250728213155068.png)

æ·»åŠ 20

![image-20250728213400158](../img/collections/image-20250728213400158.png)

**pollå‡½æ•°æºç **

```java
public E poll() {
    restartFromHead:
    for (;;) { // æ— é™å¾ªç¯
        for (Node<E> h = head, p = h, q;;) { // ä¿å­˜å¤´èŠ‚ç‚¹
            // itemé¡¹
            E item = p.item;

            if (item != null && p.casItem(item, null)) { // itemä¸ä¸ºnullå¹¶ä¸”æ¯”è¾ƒå¹¶æ›¿æ¢itemæˆåŠŸ
                // Successful CAS is the linearization point
                // for item to be removed from this queue.
                if (p != h) // pä¸ç­‰äºh    // hop two nodes at a time
                    // æ›´æ–°å¤´èŠ‚ç‚¹
                    updateHead(h, ((q = p.next) != null) ? q : p); 
                // è¿”å›item
                return item;
            }
            else if ((q = p.next) == null) { // qç»“ç‚¹ä¸ºnull
                // æ›´æ–°å¤´èŠ‚ç‚¹
                updateHead(h, p);
                return null;
            }
            else if (p == q) // pç­‰äºq
                // ç»§ç»­å¾ªç¯
                continue restartFromHead;
            else
                // pèµ‹å€¼ä¸ºq
                p = q;
        }
    }
}
```

pollç§»é™¤é“¾è¡¨çš„å¤´éƒ¨ï¼Œå¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œåˆ™è¿”å›nullï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼ˆå‡è®¾å•çº¿ç¨‹æ“ä½œï¼ŒçŠ¶æ€ä¸ºä¹‹å‰offer10ã€20åçš„çŠ¶æ€ï¼Œpollä¸¤æ¬¡ï¼‰

åˆå§‹çŠ¶æ€

![image-20250728213523254](../img/collections/image-20250728213523254.png)

ç¬¬ä¸€æ¬¡poll

![image-20250728213533332](../img/collections/image-20250728213533332.png)

ç¬¬äºŒæ¬¡poll

![image-20250728213842629](../img/collections/image-20250728213842629.png)

**removeæ“ä½œæºç **

```java
public boolean remove(Object o) {
    // å…ƒç´ ä¸ºnullï¼Œè¿”å›
    if (o == null) return false;
    Node<E> pred = null;
    for (Node<E> p = first(); p != null; p = succ(p)) { // è·å–ç¬¬ä¸€ä¸ªå­˜æ´»çš„ç»“ç‚¹
        // ç¬¬ä¸€ä¸ªå­˜æ´»ç»“ç‚¹çš„itemå€¼
        E item = p.item;
        if (item != null &&
            o.equals(item) &&
            p.casItem(item, null)) { // æ‰¾åˆ°itemç›¸ç­‰çš„ç»“ç‚¹ï¼Œå¹¶ä¸”å°†è¯¥ç»“ç‚¹çš„itemè®¾ç½®ä¸ºnull
            // pçš„åç»§ç»“ç‚¹
            Node<E> next = succ(p);
            if (pred != null && next != null) // predä¸ä¸ºnullå¹¶ä¸”nextä¸ä¸ºnull
                // æ¯”è¾ƒå¹¶æ›¿æ¢nextåŸŸ
                pred.casNext(p, next);
            return true;
        }
        // predèµ‹å€¼ä¸ºp
        pred = p;
    }
    return false;
}

final Node<E> succ(Node<E> p) {
    // pç»“ç‚¹çš„nextåŸŸ
    Node<E> next = p.next;
    // å¦‚æœnextåŸŸä¸ºè‡ªèº«ï¼Œåˆ™è¿”å›å¤´èŠ‚ç‚¹ï¼Œå¦åˆ™ï¼Œè¿”å›next
    return (p == next) ? head : next;
}
```

æ“ä½œæµç¨‹

åˆå§‹çŠ¶æ€

![image-20250728220759172](../img/collections/image-20250728220759172.png)

æ‰§è¡Œä¸€æ¬¡remove(10)

![image-20250728220814676](../img/collections/image-20250728220814676.png)

æ‰§è¡Œä¸€æ¬¡remove(20)

![image-20250728221132376](../img/collections/image-20250728221132376.png)

#### HOPSå»¶è¿Ÿæ›´æ–°ç­–ç•¥

- tailæŒ‡é’ˆæ›´æ–°æ—¶æœºï¼šå½“tailæŒ‡é’ˆçš„nextä¸ä¸ºnullæ—¶ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£å°¾ç»“ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°å°¾ç»“ç‚¹ï¼Œæ‰§è¡Œæ’å…¥åï¼Œé€šè¿‡casTailè¿›è¡Œtailçš„æ›´æ–°ï¼›å½“tailçš„nextä¸ºnullæ—¶ï¼Œåªæ’å…¥èŠ‚ç‚¹ï¼Œä¸æ›´æ–°tail
- headæŒ‡é’ˆæ›´æ–°æ—¶æœºï¼šå½“headæŒ‡é’ˆçš„nextçš„itemä¸ºnullæ—¶ï¼Œä¼šæ‰§è¡Œå®šä½é˜Ÿåˆ—çœŸæ­£å¤´èŠ‚ç‚¹çš„æ“ä½œï¼Œæ‰¾åˆ°å¤´èŠ‚ç‚¹ï¼Œæ‰§è¡Œåˆ é™¤åï¼Œé€šè¿‡updateHeadè¿›è¡Œheadæ›´æ–°ï¼›å½“headçš„nextçš„itemä¸ä¸ºnullæ—¶ï¼Œåªåˆ é™¤èŠ‚ç‚¹ä¸æ›´æ–°head

è¿™æ ·åšçš„åŸå› æ˜¯ï¼Œå¦‚æœæœ‰å¤§é‡å…¥é˜Ÿæ“ä½œï¼Œæ¯æ¬¡éƒ½éœ€è¦casè¿›è¡Œtailæ›´æ–°ï¼Œæ±‡æ€»èµ·æ¥å¯¹æ€§èƒ½ä¹Ÿæ˜¯è¾ƒå¤§çš„æŸè€—ï¼Œé€šè¿‡è¿™ä¸ªç­–ç•¥å¯ä»¥å‡å°‘casæ›´æ–°æ“ä½œï¼Œæå‡å…¥é˜Ÿæ“ä½œæ•ˆç‡

### ArrayBlockingQueue

- ArrayBlockingQueueå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå®šé•¿çš„æ•°ç»„ç”¨äºå­˜å‚¨å…ƒç´ 
- é€šè¿‡ä½¿ç”¨Reentrantlockå¯¹è¯»å†™æ“ä½œè¿›è¡ŒåŒæ­¥
- é€šè¿‡Conditionå®ç°çº¿ç¨‹é—´çš„ç­‰å¾…å’Œå”¤é†’
    - å½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notFull.await()` æ–¹æ³•è®©ç”Ÿäº§è€…è¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…é˜Ÿåˆ—éæ»¡æ—¶æ’å…¥ï¼ˆéæ»¡æ¡ä»¶ï¼‰
    - å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notEmpty.await()`æ–¹æ³•è®©æ¶ˆè´¹è€…è¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…é˜Ÿåˆ—éç©ºæ—¶æ¶ˆè´¹ï¼ˆéç©ºæ¡ä»¶ï¼‰
    - å½“æœ‰æ–°çš„å…ƒç´ è¢«æ·»åŠ æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notEmpty.signal()`æ–¹æ³•å”¤é†’æ­£åœ¨ç­‰å¾…æ¶ˆè´¹çš„æ¶ˆè´¹è€…çº¿ç¨‹
    - å½“é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ è¢«å–å‡ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notFull.signal()`æ–¹æ³•å”¤é†’æ­£åœ¨ç­‰å¾…æ’å…¥å…ƒç´ çš„ç”Ÿäº§è€…çº¿ç¨‹

![image-20250728224151220](../img/collections/image-20250728224151220.png)

#### ArrayBlockingQueueå’ŒConcurrentLinkedQueueåŒºåˆ«

`ArrayBlockingQueue` å’Œ `ConcurrentLinkedQueue` æ˜¯ Java å¹¶å‘åŒ…ä¸­å¸¸ç”¨çš„ä¸¤ç§é˜Ÿåˆ—å®ç°ï¼Œå®ƒä»¬éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

- åº•å±‚å®ç°ï¼š`ArrayBlockingQueue` åŸºäºæ•°ç»„å®ç°ï¼Œè€Œ `ConcurrentLinkedQueue` åŸºäºé“¾è¡¨å®ç°
- æ˜¯å¦æœ‰ç•Œï¼š`ArrayBlockingQueue` æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¿…é¡»åœ¨åˆ›å»ºæ—¶æŒ‡å®šå®¹é‡å¤§å°ï¼Œè€Œ `ConcurrentLinkedQueue` æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¯ä»¥åŠ¨æ€åœ°å¢åŠ å®¹é‡
- æ˜¯å¦é˜»å¡ï¼š`ArrayBlockingQueue` æ”¯æŒé˜»å¡ï¼ˆputå’Œtakeï¼‰å’Œéé˜»å¡ï¼ˆofferå’Œpollï¼‰ä¸¤ç§è·å–å’Œæ–°å¢å…ƒç´ çš„æ–¹å¼ï¼ˆä¸€èˆ¬åªä¼šä½¿ç”¨å‰è€…ï¼‰ï¼Œ `ConcurrentLinkedQueue` æ˜¯æ— ç•Œçš„ï¼Œä»…æ”¯æŒéé˜»å¡å¼è·å–å’Œæ–°å¢å…ƒç´ 

![image-20250728224037193](../img/collections/image-20250728224037193.png)

### BlockingDeque

![image-20250728224318424](../img/collections/image-20250728224318424.png)

å”¯ä¸€å®ç°ï¼šLinkedBlockingDeque

![image-20250728225249733](../img/collections/image-20250728225249733.png)

### DelayQueueå»¶è¿Ÿé˜Ÿåˆ—

`DelayQueue` æ˜¯ Java å¹¶å‘åŒ…ä¸­ä¸€ä¸ª **æ— ç•Œé˜»å¡é˜Ÿåˆ—**ï¼Œç”¨äºæ”¾ç½®å®ç°äº† `Delayed` æ¥å£çš„å…ƒç´ ï¼Œåªæœ‰å½“å…ƒç´ çš„å»¶è¿Ÿæ—¶é—´åˆ°äº†ï¼Œæ‰èƒ½ä»é˜Ÿåˆ—ä¸­å–å‡ºã€‚å¸¸ç”¨äºï¼š

- å®šæ—¶ä»»åŠ¡è°ƒåº¦
- ç¼“å­˜å¤±æ•ˆé˜Ÿåˆ—
- è¶…æ—¶æ§åˆ¶ç­‰åœºæ™¯

æ³¨å…¥å…¶ä¸­çš„å…ƒç´ å¿…é¡»å®ç° java.util.concurrent.Delayed æ¥å£ï¼Œè¯¥æ¥å£å®šä¹‰:

```java
public interface Delayed extends Comparable<Delayed< {
    public long getDelay(TimeUnit timeUnit);
}
```

| ç‰¹æ€§                        | æè¿°                           |
| --------------------------- | ------------------------------ |
| å…ƒç´ å¿…é¡»å®ç° `Delayed` æ¥å£ | åŒ…å«å»¶è¿Ÿæ—¶é—´å’Œæ’åºé€»è¾‘         |
| å‡ºé˜Ÿé¡ºåº                    | æŒ‰å»¶è¿Ÿæ—¶é—´ä»å°åˆ°å¤§             |
| `take()` ä¼šé˜»å¡             | ç›´åˆ°æœ‰å…ƒç´ åˆ°æœŸå¯å–             |
| æ— ç•Œé˜Ÿåˆ—                    | æ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œä½†è¦æ³¨æ„å†…å­˜æ§åˆ¶ |

ä¾‹å­

![image-20250728230032147](../img/collections/image-20250728230032147.png)

# Map

## HashMap

### 1.8ä¹‹å‰

åº•å±‚æ˜¯æ•°ç»„åŠ é“¾è¡¨å®ç°

![image-20250729214836410](../img/collections/image-20250729214836410.png)

é€šè¿‡keyçš„hashcodeå†ç»è¿‡æ‰°åŠ¨å‡½æ•°ï¼ˆå‡å°‘ç¢°æ’ï¼‰å¤„ç†å¾—åˆ°hashå€¼ï¼Œå†è¿›è¡Œ`(n-1)&hash`å¾—åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœå½“å‰ä½ç½®æœ‰å…ƒç´ ï¼Œå°±åˆ¤æ–­valæ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œå°±è¦†ç›–ï¼Œå¦åˆ™åŠ åˆ°é“¾è¡¨ä¸­

1.8æ‰°åŠ¨å‡½æ•°

```java
    static final int hash(Object key) {
      int h;
      // key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode
      // ^ï¼šæŒ‰ä½å¼‚æˆ–
      // >>>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
      return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
  }
```

1.7æ‰°åŠ¨å‡½æ•°

```java
static int hash(int h) {
    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).

    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}
```

ç›¸æ¯”äº JDK1.8 çš„ hash æ–¹æ³• ï¼ŒJDK 1.7 çš„ hash æ–¹æ³•çš„æ€§èƒ½ä¼šç¨å·®ä¸€ç‚¹ç‚¹ï¼Œå› ä¸ºæ¯•ç«Ÿæ‰°åŠ¨äº† 4 æ¬¡

### 1.8ä¹‹å

æ’å…¥èŠ‚ç‚¹ï¼Œ**å½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º8ï¼‰æ—¶**ï¼Œä¼šè°ƒç”¨treeifyBinå‡½æ•°ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå…ˆåˆ¤æ–­å½“å‰æ•°ç»„é•¿åº¦æ˜¯å¦å°äº64ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œresizeæ–¹æ³•ï¼Œå¯¹æ•°ç»„æ‰©å®¹ï¼ˆå¢é•¿ä¸ºåŸæ¥çš„2å€ï¼‰ï¼Œå¦åˆ™å°±å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘

#### **æ¡¶æœ€å¤§é•¿åº¦æ˜¯MAXIMUM_CAPACITY = 1<<30ï¼Œå³2^30ï¼Œ1.8ä¹‹å‰ä¹Ÿæ˜¯ä¸€æ ·**

#### ä¸ºä»€ä¹ˆæ˜¯8å’Œ64

- æ³Šæ¾åˆ†å¸ƒè¡¨æ˜ï¼Œé“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„æ¦‚ç‡æä½ï¼Œæ‰€ä»¥è®¾ç½®ä¸º8ï¼Œèƒ½è¾¾åˆ°æ€§èƒ½å’Œç©ºé—´æ•ˆç‡çš„å¹³è¡¡
- æ•°ç»„é•¿åº¦ä¸º64ï¼ŒåŒæ ·æ˜¯å®è·µéªŒè¯çš„ç»éªŒå€¼

#### ä¸ºä»€ä¹ˆè½¬æ¢ä¸ºçº¢é»‘æ ‘

å› ä¸ºé“¾è¡¨çš„æŸ¥è¯¢æ•ˆç‡æ˜¯O(n)ï¼Œçº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡æ˜¯O(logn)ï¼Œå½“é“¾è¡¨è¾ƒçŸ­çš„æ—¶å€™ï¼Œä¸¤è€…æŸ¥è¯¢æ•ˆç‡ç›¸å½“ï¼Œä½†æ˜¯é“¾è¡¨å˜é•¿æ—¶ï¼Œçº¢é»‘æ ‘æŸ¥è¯¢æ€§èƒ½æ›´ä¼˜

çº¢é»‘æ ‘æ˜¯ä¸ºäº†è§£å†³äºŒå‰æŸ¥æ‰¾æ ‘çš„ç¼ºé™·ï¼Œå› ä¸ºäºŒå‰æŸ¥æ‰¾æ ‘åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé€€åŒ–æˆçº¿æ€§ç»“æ„

#### ä¸ºä»€ä¹ˆä¼˜å…ˆæ‰©å®¹è€Œä¸æ˜¯ç›´æ¥è½¬æ¢ä¸ºçº¢é»‘æ ‘

æ‰©å®¹æ•°ç»„èƒ½é™ä½å“ˆå¸Œå†²çªï¼Œåœ¨æ•°ç»„é•¿åº¦ä½äº64çš„æƒ…å†µä¸‹ï¼Œæ‰©å®¹æ•°ç»„çš„æ•ˆç‡æ¯”è½¬æ¢çº¢é»‘æ ‘æ›´ä¼˜ï¼Œçº¢é»‘æ ‘éœ€è¦ä¿æŒè‡ªå¹³è¡¡ï¼Œè¿‡æ—©å¼•å…¥çº¢é»‘æ ‘ä¼šå¢åŠ å¤æ‚åº¦

#### HashMapçš„é•¿åº¦ä¸ºä»€ä¹ˆæ˜¯2çš„å¹‚æ¬¡æ–¹

- ä½è¿ç®—æ›´é«˜æ•ˆï¼šå½“é•¿åº¦ä¸º2çš„å¹‚æ¬¡æ–¹æ—¶ï¼Œhashè·Ÿlengthçš„å–ä½™è¿ç®—`hash % length`ç­‰ä»·äºlength-1å’Œhashçš„ä¸è¿ç®—`hash & (length-1)`
- æ›´å¥½åœ°ä¿è¯å“ˆå¸Œå€¼å‡åŒ€åˆ†å¸ƒï¼šæœ€å¥½çš„æƒ…å†µä¼šæœ‰ä¸€åŠå€¼åœ¨æ•°ç»„å‰åŠéƒ¨åˆ†ï¼Œä¸€åŠå€¼åœ¨æ•°ç»„ååŠéƒ¨åˆ†

#### ä»€ä¹ˆæ—¶å€™ä¼šresize

- å½“é”®å€¼å¯¹ä¸ªæ•°è¶…è¿‡é˜ˆå€¼ï¼ˆcapacity * loadFactorï¼‰ï¼Œcapacityæ˜¯æ•°ç»„é•¿åº¦ï¼Œä¸€å¼€å§‹æ˜¯16ï¼ŒloadFactoræ˜¯è´Ÿè½½å› å­ï¼Œé»˜è®¤ä¸º0.75f
- é“¾è¡¨é•¿åº¦è¾¾åˆ°8ä¸”æ•°ç»„é•¿åº¦å°äº64

#### HashMapå¤šçº¿ç¨‹å¯¼è‡´æ­»å¾ªç¯é—®é¢˜

1.8ä¹‹å‰çš„hashmapåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ‰©å®¹æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ­»å¾ªç¯é—®é¢˜ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯**å¤´æ’æ³•**ï¼Œå¤šä¸ªçº¿ç¨‹å¯¹é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æ“ä½œå¯èƒ½ä¼šå¯¼è‡´**ç¯å½¢é“¾è¡¨**ï¼Œä½¿å¾—æŸ¥è¯¢å…ƒç´ çš„æ—¶å€™é™·å…¥æ­»å¾ªç¯ï¼Œæ— æ³•ç»“æŸ

è§£å†³åŠæ³•ï¼š1.8ä½¿ç”¨äº†å°¾æ’æ³•ï¼Œé¿å…å‡ºç°ç¯å½¢é“¾è¡¨ï¼Œä½†ä»ç„¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±ï¼ˆè¦†ç›–ï¼‰é—®é¢˜

#### HashMapä¸ºä»€ä¹ˆä¸æ˜¯çº¿ç¨‹å®‰å…¨

ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œputæ“ä½œï¼Œçº¿ç¨‹1å…ˆåˆ¤æ–­æ˜¯å¦å“ˆå¸Œå†²çªï¼Œåˆ¤æ–­å®Œåï¼Œcpuæ—¶é—´ç‰‡è€—å°½ï¼Œäºæ˜¯æŒ‚èµ·ï¼Œæ­¤æ—¶çº¿ç¨‹2è·å–åˆ°æ—¶é—´ç‰‡æ‰§è¡Œï¼Œä¹Ÿæ˜¯å…ˆåˆ¤æ–­æ˜¯å¦å“ˆå¸Œå†²çªï¼Œåˆ¤æ–­æ— å†²çªåï¼ˆæ­¤æ—¶çº¿ç¨‹1çš„èŠ‚ç‚¹è¿˜æ²¡èµ‹å€¼ï¼‰ï¼Œå®Œæˆæ’å…¥æ“ä½œï¼Œç„¶åçº¿ç¨‹1å†æ¬¡è·å¾—æ—¶é—´ç‰‡æ‰§è¡Œï¼Œè¿›è¡Œæ’å…¥æ“ä½œï¼ˆä¹‹å‰å·²åˆ¤æ–­è¿‡å“ˆå¸Œå†²çªï¼‰ï¼Œå¯¼è‡´çº¿ç¨‹2çš„æ’å…¥æ•°æ®è¢«çº¿ç¨‹1çš„è¦†ç›–äº†

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    // ...
    // (n - 1) & hash ç¡®å®šå…ƒç´ å­˜æ”¾åœ¨å“ªä¸ªæ¡¶ä¸­ï¼Œæ¡¶ä¸ºç©ºï¼Œæ–°ç”Ÿæˆç»“ç‚¹æ”¾å…¥æ¡¶ä¸­(æ­¤æ—¶ï¼Œè¿™ä¸ªç»“ç‚¹æ˜¯æ”¾åœ¨æ•°ç»„ä¸­)
    if ((p = tab[i = (n - 1) & hash]) == null) // åˆ¤æ–­æ˜¯å¦å‡ºç° hash ç¢°æ’
        tab[i] = newNode(hash, key, value, null);
    // æ¡¶ä¸­å·²ç»å­˜åœ¨å…ƒç´ ï¼ˆå¤„ç†hashå†²çªï¼‰
    else {
    // ...
}
```

#### HashMapå¸¸è§éå†æ–¹å¼

```java
// entrySet
for (Map.Entry<Integer, String> entry : map.entrySet()) {
    System.out.println("Key: " + entry.getKey() + ", Value: " + entry.getValue());
}

// keySet
for (Integer key : map.keySet()) {
    String value = map.get(key);
    System.out.println("Key: " + key + ", Value: " + value);
}

// Lambda
map.forEach((key, value) -> {
    System.out.println("Key: " + key + ", Value: " + value);
});

// parallelStream
map.entrySet().parallelStream().forEach(entry -> {
    System.out.println(Thread.currentThread().getName() +
                       " -> Key: " + entry.getKey() +
                       ", Value: " + entry.getValue());
});
```

å½“éå†ä¸å­˜åœ¨é˜»å¡æ—¶, parallelStream çš„æ€§èƒ½æ˜¯æœ€ä½çš„ï¼š

```java
Benchmark               Mode  Cnt     Score      Error  Units
Test.entrySet           avgt    5   288.651 Â±   10.536  ns/op
Test.keySet             avgt    5   584.594 Â±   21.431  ns/op
Test.lambda             avgt    5   221.791 Â±   10.198  ns/op
Test.parallelStream     avgt    5  6919.163 Â± 1116.139  ns/op
```

åŠ å…¥é˜»å¡ä»£ç `Thread.sleep(10)`å, parallelStream çš„æ€§èƒ½æ‰æ˜¯æœ€é«˜çš„:

```
Benchmark               Mode  Cnt           Score          Error  Units
Test.entrySet           avgt    5  1554828440.000 Â± 23657748.653  ns/op
Test.keySet             avgt    5  1550612500.000 Â±  6474562.858  ns/op
Test.lambda             avgt    5  1551065180.000 Â± 19164407.426  ns/op
Test.parallelStream     avgt    5   186345456.667 Â±  3210435.590  ns/op
```

#### HashMapå’ŒHashTableåŒºåˆ«

- HashTableæ˜¯çº¿ç¨‹å®‰å…¨ï¼ˆputå’Œgetéƒ½ç”¨synchronizedä¿®é¥°ï¼‰ï¼ŒHashMapéçº¿ç¨‹å®‰å…¨
- HashMapæ”¯æŒkeyå’Œvalueä¸ºnullï¼Œä½†keyåªèƒ½æœ‰ä¸€ä¸ªnullï¼Œnullä¸ºå€¼èƒ½æœ‰å¤šä¸ªï¼›HashTableä¸èƒ½ä¼ å…¥nullçš„keyå’Œval
- HashMapçš„åˆå§‹å®¹é‡æ˜¯16ï¼Œæ‰©å®¹æ˜¯*2ï¼Œå¦‚æœç»™å®šåˆå§‹åŒ–å¤§å°ï¼Œä¼šå°†å…¶æ‰©å……ä¸º2çš„å¹‚æ¬¡æ–¹å¤§å°ï¼ˆå¤§äºç­‰äºç»™å®šå®¹é‡çš„æœ€å°çš„2^nï¼Œæ¯”å¦‚ç»™å®šå®¹é‡ä¸º20ï¼Œä¼šæŠŠå†…éƒ¨å®¹é‡è°ƒæ•´ä¸º32ï¼Œå³2^5ï¼‰ï¼›HashTableåˆå§‹å®¹é‡æ˜¯11ï¼Œæ‰©å®¹æ˜¯2n+1ï¼Œå¦‚æœç»™å®šåˆå§‹åŒ–å¤§å°ï¼Œä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªå€¼
- HashMapçš„é“¾è¡¨ä¼šè½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼›HashTableä¸ä¼š
- HashMapçš„å“ˆå¸Œå‡½æ•°ç»è¿‡å¤šæ¬¡æ‰°åŠ¨ä»¥å‡å°‘å†²çªï¼›HashTableç›´æ¥ä½¿ç”¨é”®çš„hashCodeæ–¹æ³•



## ConcurrentHashMap

### 1.8ä¹‹å‰

Segmentæ•°ç»„ï¼Œæ¯ä¸ªSegmentå«æœ‰ä¸€ä¸ªHashEntryæ•°ç»„ï¼ŒHashEntryæ•°ç»„çš„å…ƒç´ å°±æ˜¯HashEntryçš„é“¾è¡¨

```shell
ConcurrentHashMap
  â””â”€â”€ Segment<K, V>[] segments  // é»˜è®¤é•¿åº¦ä¸º16ï¼ˆå¯é…ç½®ï¼‰
           â””â”€â”€ HashEntry<K,V>[] table   // æ¯ä¸ª Segment ç»´æŠ¤è‡ªå·±çš„ Hash æ¡¶æ•°ç»„
                     â””â”€â”€ HashEntry<K,V> next é“¾è¡¨ç»“æ„ï¼ˆå¤´æ’ï¼‰
```

![image-20250730211512346](../img/collections/image-20250730211512346.png)

### 1.8

Nodeæ•°ç»„+é“¾è¡¨/çº¢é»‘æ ‘

![image-20250730211948872](../img/collections/image-20250730211948872.png)

#### ConcurrentHashMapå’ŒHashTableçš„åŒºåˆ«

- ConcurrentHashMapçš„åº•å±‚ç»“æ„æ˜¯æ•°ç»„+é“¾è¡¨/çº¢é»‘æ ‘ï¼›HashTableæ˜¯æ•°ç»„+é“¾è¡¨
- ConcurrentHashMap1.8å‰ä½¿ç”¨åˆ†æ®µé”å®ç°çº¿ç¨‹å®‰å…¨ï¼Œ1.8å¼€å§‹ï¼Œä½¿ç”¨synchronized+caså®ç°çº¿ç¨‹å®‰å…¨ï¼›HashTableä½¿ç”¨synchronizedï¼ˆåŒä¸€æŠŠï¼‰å®ç°çº¿ç¨‹å®‰å…¨

#### ConcurrentHashMapçº¿ç¨‹å®‰å…¨å…·ä½“å®ç°

1.8ä¹‹å‰ï¼Œåˆ†æ®µé”ï¼ŒSegmentç»§æ‰¿äº†ReentrantLockï¼Œæ‰€ä»¥æ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œputçš„æ—¶å€™ç›´æ¥è°ƒlockæ–¹æ³•

```java
static class Segment<K,V> extends ReentrantLock implements Serializable {
}
```

Segmentä¸ªæ•°ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½æ”¹å˜ï¼Œé»˜è®¤æ˜¯16ï¼Œä¹Ÿå°±æ˜¯è¯´åŒæ—¶æ”¯æŒ16ä¸ªçº¿ç¨‹å¹¶å‘å†™

è¯»ä¸åŠ é”ï¼ŒHashEntryçš„valueç”¨volatileä¿®é¥°

1.8ä¹‹åï¼Œé€šè¿‡synchronizedé”ä½å½“å‰çš„é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„å¤´èŠ‚ç‚¹ï¼Œé€šè¿‡casè¿›è¡Œæ›´æ–°

åŒæ ·è¯»ä¸åŠ é”ï¼ŒNodeçš„valueç”¨volatileä¿®é¥°

#### ä¸ºä»€ä¹ˆConcurrentHashMapçš„keyå’Œvalueä¸èƒ½ä¸ºnullï¼Œè€ŒHashMapå¯ä»¥

1. åœ¨å¹¶å‘ç¯å¢ƒä¸­ä¸å®¹è®¸è¯­æ„æ¨¡ç³Šï¼Œæ¯”å¦‚map.get(key) == nullï¼Œæ— æ³•åˆ¤æ–­æ˜¯keyä¸å­˜åœ¨è¿˜æ˜¯å€¼ä¸ºnullï¼Œè€Œåœ¨å•çº¿ç¨‹æ—¶å¯ä»¥ï¼ŒHashMapå…è®¸ä¸€ä¸ªkeyä¸ºnullï¼Œæ”¾åœ¨Node[0]
2. å½“valæ˜¯nullæ—¶ï¼Œcasæ“ä½œæ— æ³•å®‰å…¨åˆ¤æ–­å€¼æ˜¯å¦æœªè¢«ä¿®æ”¹

å¦‚æœç¡®å®éœ€è¦åŒºåˆ†å€¼ä¸ºnullå’Œæ²¡æœ‰å€¼ï¼Œå¯ä»¥ä½¿ç”¨Optionalï¼Œæ¯”å¦‚

```java
Map<String, Optional<String>> userNicknames = new HashMap<>();

// ç”¨æˆ· ID ä¸º "123"ï¼Œæœ‰æ˜µç§°ä½†ä¸ºç©º
userNicknames.put("123", Optional.of("Alice"));

// ç”¨æˆ· ID ä¸º "456"ï¼Œæ˜ç¡®è¡¨ç¤ºæ²¡æœ‰æ˜µç§°ï¼ˆä¸æ˜¯å€¼ä¸º nullï¼Œè€Œæ˜¯ä¸šåŠ¡å«ä¹‰å°±æ˜¯æ²¡æœ‰ï¼‰
userNicknames.put("456", Optional.empty());

Optional<String> nicknameOpt = userNicknames.get("123");

if (nicknameOpt != null && nicknameOpt.isPresent()) {
    System.out.println("æ˜µç§°æ˜¯: " + nicknameOpt.get());
} else if (nicknameOpt != null) {
    System.out.println("ç”¨æˆ·æ²¡æœ‰æ˜µç§°");
} else {
    System.out.println("ç”¨æˆ·ä¸å­˜åœ¨");
}
```



#### ConcurrentHashMapä¸èƒ½ä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§

ConcurrentHashMapå¯ä»¥ä¿è¯å•ä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œå¦‚putã€getã€removeã€containsKey

ä½†ä¸èƒ½ä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§ï¼Œæ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹æƒ³è¦æ’å…¥å…ƒç´ 

```java
// çº¿ç¨‹ A
if (!map.containsKey(key)) {
map.put(key, value);
}
// çº¿ç¨‹ B
if (!map.containsKey(key)) {
map.put(key, anotherValue);
}
/**
å¯èƒ½çš„æ‰§è¡Œé¡ºåºï¼š
1ã€çº¿ç¨‹ A åˆ¤æ–­ map ä¸­ä¸å­˜åœ¨ key
2ã€çº¿ç¨‹ B åˆ¤æ–­ map ä¸­ä¸å­˜åœ¨ key
3ã€çº¿ç¨‹ B å°† (key, anotherValue) æ’å…¥ map
4ã€çº¿ç¨‹ A å°† (key, value) æ’å…¥ map
*/
```

é¢„æœŸç»“æœæ˜¯ï¼ˆkeyï¼ŒanotherValueï¼‰ï¼Œä½†å®é™…ç»“æœæ˜¯(key, value)

**å¦‚ä½•ä¿è¯ï¼Ÿ**

```
// çº¿ç¨‹ A
map.putIfAbsent(key, value);
// çº¿ç¨‹ B
map.putIfAbsent(key, anotherValue);
// æˆ–è€…
// çº¿ç¨‹ A
map.computeIfAbsent(key, k -> value);
// çº¿ç¨‹ B
map.computeIfAbsent(key, k -> anotherValue);
```

