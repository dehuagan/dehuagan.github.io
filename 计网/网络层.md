# 路由器和交换机的区别
- 路由器工作在网络层，交换机工作在数据链路层
- 路由器依靠IP地址，路由器内有一份路由表，里面有寻址信息，收到网络层的数据报后，会根据路由表和选路算法将数据报转发到下一站。
- 交换机依靠MAC地址，内有一张MAC表，里面存放这和它相连的所有设备的MAC地址，会根据收到的数据帧的首部信息内的目的MAC地址在表中查找，如果有则转发，无则放弃。


# ICMP
[详细](https://mp.weixin.qq.com/s/3KF0IxLum8EOtcF0ZNIiPA)

## 是什么
> ICMP全称是Internet Control Message Protocol，互联网控制协议。属于网络层协议。

## 功能
> 确认IP包是否成功送达目标地址、报告发送过程中IP包被废弃的原因和改善网络设置等。

## 应用
### ping
1. 源主机首先会构建一个ICMP回送请求消息数据包
2. 然后，由ICMP协议将这个数据包连同目的地址一起交给IP层，本机IP地址作为原地址，协议字段设置为1，表示是ICMP协议，再加上一些其他控制信息，构建一个IP数据包
3. 接下来，需要加上MAC头。如果在本地ARP映射表中查找出IP地址所对应的MAC地址，则可以直接使用，如果没有，则需要发送ARP协议查询MAC地址，获得MAC地址后，由数据链路层构建一个数据帧，目的地址是IP层传过来的MAC地址，源地址则是本机的MAC地址
4. 主机B收到这个数据帧后，先检查它的目的MAC地址，并和本机的MAC地址对比，如符合，则接收，否则丢弃
5. 接收后，检查该数据帧，将IP数据包从帧中提取出来，交给本机的IP层，同样IP层检查后，将有用的信息提取后交给ICMP协议。
6. 主机B会构建一个ICMP回送响应消息数据包，回送响应数据包的类型字段为0，序号为接收到的请求数据包中的序号，然后再发送回给主机A
7. 在规定的时间内，源主机如果没有收到ICMP的应答包，则说明目标主机不可达，如果收到，则说明目标主机可达。

### traceroute
traceroute 的第一个作用就是故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。

traceroute 的参数指向某个目的 IP 地址：

traceroute 192.168.1.100
> 它的原理就是利用 IP 包的生存期限 从 1 开始按照顺序递增的同时发送 UDP 包，强制接收 ICMP 超时消息的一种方法。

> 比如，将 TTL 设置 为 1，则遇到第一个路由器，就牺牲了，接着返回 ICMP 差错报文网络包，类型是时间超时。
> 
> 接下来将 TTL 设置为 2，第一个路由器过了，遇到第二个路由器也牺牲了，也同意返回了 ICMP 差错报文数据包，如此往复，直到到达目的主机。
> 
> 这样的过程，traceroute 就可以拿到了所有的路由器 IP。
> 
> 当然有的路由器根本就不会返回这个 ICMP，所以对于有的公网地址，是看不到中间经过的路由的。

